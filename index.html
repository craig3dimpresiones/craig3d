<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Craig 3D</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html { min-height: 100%; background: #0f172a; color: white; margin:0; padding:0; }
        .seccion { display: none; } 
        .activa { display: block !important; }
        input { color: black; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.open { display: flex; }
        .admin-only { display: none; }
        body.is-admin .admin-only { display: block !important; }
    </style>
</head>
<body>

    <header class="p-5 bg-slate-900 border-b-2 border-red-600 flex justify-between items-center sticky top-0 z-50">
        <h1 onclick="window.location.reload()" class="font-black italic uppercase text-xl">Craig <span class="text-red-600">3D</span></h1>
        <div id="status-area">
            <button onclick="ver('login')" id="btn-login-header" class="text-[10px] font-bold border border-slate-700 px-3 py-1 rounded-full">ADMIN</button>
            <button onclick="logout()" class="admin-only text-[10px] font-bold text-red-500 bg-red-500/10 px-3 py-1 rounded-full">SALIR</button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4">

        <div id="sec-login" class="seccion space-y-6 pt-10">
            <div class="text-center space-y-2">
                <h2 class="text-2xl font-black italic uppercase">Panel de Control</h2>
                <p class="text-slate-400 text-xs">Ingres√° tus credenciales</p>
            </div>
            <div class="space-y-3">
                <input type="text" id="log-nombre" placeholder="USUARIO" class="w-full p-4 rounded-xl font-bold uppercase outline-none">
                <input type="password" id="log-pass" placeholder="CONTRASE√ëA" class="w-full p-4 rounded-xl font-bold outline-none">
                <button onclick="ejecutarLogin()" id="btn-entrar-posta" class="w-full bg-red-600 text-white p-4 rounded-xl font-black uppercase shadow-lg hover:bg-red-700 transition-colors">
                    Entrar al Taller
                </button>
                <button onclick="ver('cata')" class="w-full text-slate-500 text-xs font-bold uppercase py-2">Volver al Cat√°logo</button>
            </div>
        </div>

        <div id="sec-inicio" class="seccion admin-only space-y-4 pt-4">
            <div class="bg-slate-800 p-4 rounded-2xl border-l-4 border-red-600">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Operador:</p>
                <p id="user-display" class="font-black uppercase italic">---</p>
            </div>
            <button onclick="ver('calc')" class="w-full bg-white text-slate-900 p-6 rounded-2xl font-black uppercase flex justify-between items-center">
                <span>Nueva Cotizaci√≥n</span> <span>+</span>
            </button>
            <button onclick="ver('cata')" class="w-full bg-white text-slate-900 p-6 rounded-2xl font-black uppercase flex justify-between items-center">
                <span>Ver Cat√°logo</span> <span>‚ûî</span>
            </button>
            <button onclick="ver('config')" class="w-full bg-slate-700 p-4 rounded-2xl font-black uppercase text-sm">Configuraci√≥n de Costos</button>
        </div>

        <div id="sec-calc" class="seccion space-y-4">
            <button onclick="ver('inicio')" class="text-red-500 font-bold text-xs uppercase underline">‚Üê Volver</button>
            <div class="bg-white text-slate-900 p-6 rounded-2xl space-y-4 shadow-xl">
                <input type="hidden" id="edit-id">
                <input type="text" id="nombre" placeholder="Nombre de la pieza" class="w-full border-b-2 p-2 font-black uppercase outline-none text-lg">
                <textarea id="descripcion" placeholder="Descripci√≥n vendedora..." class="w-full border-2 p-2 rounded-lg text-sm h-20 outline-none"></textarea>
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="gramos" placeholder="Gramos" class="bg-slate-100 p-3 rounded-lg font-black" oninput="calcular()">
                    <input type="number" id="minutos" placeholder="Minutos" class="bg-slate-100 p-3 rounded-lg font-black" oninput="calcular()">
                </div>
                <div class="bg-blue-50 border-2 border-dashed border-blue-200 p-4 rounded-xl text-center cursor-pointer" onclick="document.getElementById('foto').click()">
                    <input type="file" id="foto" accept="image/*" capture="environment" class="hidden">
                    <span id="txtFoto" class="text-blue-600 font-black text-[10px] uppercase">üì∏ Sacar Foto</span>
                </div>
                <div class="bg-slate-900 p-4 rounded-xl text-center">
                    <p id="precioFinal" class="text-4xl font-black text-green-400 italic">$0</p>
                </div>
                <button onclick="guardarPieza()" id="btnG" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black uppercase">Guardar en Cat√°logo</button>
            </div>
        </div>

        <div id="sec-cata" class="seccion activa space-y-4">
            <input type="text" id="buscador" oninput="filtrar()" placeholder="üîç Buscar pieza..." class="w-full p-4 rounded-xl text-slate-900 font-bold outline-none">
            <div id="grid-productos" class="grid grid-cols-2 gap-3 pb-20"></div>
        </div>

    </main>

    <div id="modalDetalle" class="modal" onclick="this.classList.remove('open')">
        <div class="bg-white text-slate-900 w-full max-w-sm rounded-3xl overflow-hidden" onclick="event.stopPropagation()">
            <img id="detImg" class="w-full h-64 object-cover border-b-4 border-red-600">
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-center">
                    <h3 id="detNom" class="font-black text-xl uppercase italic"></h3>
                    <p id="detPre" class="text-xl font-black text-blue-600 italic"></p>
                </div>
                <p id="detDes" class="text-sm text-slate-500 italic"></p>
                <button onclick="pedidoWhatsapp()" class="w-full bg-green-600 text-white p-4 rounded-xl font-black uppercase text-sm">Lo quiero por WhatsApp</button>
                <div class="admin-only flex gap-2 pt-2 border-t">
                    <button onclick="editarActual()" class="flex-1 bg-slate-100 p-2 rounded font-bold text-xs uppercase">Editar</button>
                    <button onclick="borrarActual()" class="flex-1 bg-red-50 text-red-500 p-2 rounded font-bold text-xs uppercase">Borrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACION SUPABASE
        const SB_URL = 'https://acsxhpotasjilafhqmoz.supabase.co'; 
        const SB_KEY = 'sb_publishable_sDXHl5jEwIRktVlJbIH2Lg_EYYMd_bF';
        let supabaseClient;
        let config = { filamento: 21000, luz: 0.5, desgaste: 3.9, error: 10, ganancia: 80 };
        let totalProductos = [];
        let itemActual = null;
        let fotoFinal = "";

        // ESTA FUNCION ES EL "MOTOR" DE LA APP
        window.onload = async () => {
            supabaseClient = supabase.createClient(SB_URL, SB_KEY);
            
            // Ver si ya sos admin
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                document.body.classList.add('is-admin');
                document.getElementById('user-display').innerText = session.user.email.split('@')[0];
                document.getElementById('btn-login-header').style.display = 'none';
            }

            await cargarCata();
            
            // Si viene un link de producto:
            const pId = new URLSearchParams(window.location.search).get('p');
            if(pId) {
                const p = totalProductos.find(x => x.id == pId);
                if(p) abrirDetalle(p);
            }
        };

        async function ejecutarLogin() {
            const n = document.getElementById('log-nombre').value.toLowerCase().trim();
            const p = document.getElementById('log-pass').value;
            const btn = document.getElementById('btn-entrar-posta');

            if(!n || !p) { alert("Complet√° todo"); return; }
            
            btn.innerText = "ENTRANDO...";
            btn.disabled = true;

            const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                email: n + "@craig.com", 
                password: p 
            });

            if (error) {
                alert("Error: " + error.message);
                btn.innerText = "Entrar al Taller";
                btn.disabled = false;
            } else {
                window.location.href = window.location.pathname; // Recarga limpia
            }
        }

        async function logout() { await supabaseClient.auth.signOut(); window.location.reload(); }

        function ver(id) {
            document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activa'));
            document.getElementById('sec-' + id).classList.add('activa');
        }

        async function cargarCata() {
            const { data } = await supabaseClient.from('productos').select('*').order('id', {ascending: false});
            totalProductos = data || [];
            document.getElementById('grid-productos').innerHTML = totalProductos.map(p => `
                <div onclick='abrirDetalle(${JSON.stringify(p)})' class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700">
                    <img src="${p.imagen}" class="aspect-square w-full object-cover">
                    <div class="p-2">
                        <div class="text-blue-400 font-black text-xs">$${p.precio}</div>
                        <div class="text-[10px] font-
